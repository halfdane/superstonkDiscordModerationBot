name: test, deploy and run
on: [push, workflow_dispatch]
jobs:
  test:
    runs-on: ubuntu-latest
    environment: live
    steps:
      - uses: actions/checkout@v1.0.0
      - run: make test
  deploy:
    runs-on: ubuntu-latest
    needs: test
    environment: live
    steps:
    - name: Deploy to live server via ssh
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          cd superstonkDiscordModerationBot
          git pull --rebase
          export discord_bot_token="${{ secrets.DISCORD_BOT_TOKEN }}"
          export target_subreddit="${{ secrets.REDDIT_CLIENT_SECRET }}"
          
          export reddit_client_id="${{ secrets.REDDIT_CLIENT_ID }}"
          export reddit_client_secret="${{ secrets.REDDIT_CLIENT_SECRET }}"
          export reddit_username="${{ secrets.REDDIT_USERNAME }}"
          export reddit_password="${{ secrets.REDDIT_PASSWORD }}"
    
          export flairy_client_id="${{ secrets.FLAIRY_CLIENT_ID }}"
          export flairy_client_secret="${{ secrets.FLAIRY_CLIENT_SECRET }}"
          export flairy_username="${{ secrets.FLAIRY_USERNAME }}"
          export flairy_password="${{ secrets.FLAIRY_PASSWORD }}"
    
          export qvbot_username="${{ secrets.QVBOT_CLIENT_ID }}"
          export qvbot_password="${{ secrets.QVBOT_CLIENT_ID }}"
          export qvbot_client_id="${{ secrets.QVBOT_CLIENT_ID }}"
          export qvbot_client_secret="${{ secrets.QVBOT_CLIENT_ID }}"
          
          
          export GUILD="${{ secrets.GUILD }}"
          export REPORTING_CHANNEL="${{ secrets.REPORTING_CHANNEL }}"
          export FLAIRY_CHANNEL="${{ secrets.FLAIRY_CHANNEL }}"
          export USER_INVESTIGATION_CHANNELS="${{ secrets.USER_INVESTIGATION_CHANNELS }}"
          export LOG_OUTPUT_CHANNEL="${{ secrets.LOG_OUTPUT_CHANNEL }}"
          
          export LOG_FILE=/var/log/superstonkDiscordModerationBot_`date +"%Y%m%d_%H%M"`.log
          make >"${LOG_FILE}" 2>&1 &
          ln -sf "${LOG_FILE}" /var/log/superstonkDiscordModerationBot.log
          echo "That's all folks"
